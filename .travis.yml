dist: bionic
language: python
python: "3.8"

before_install:
  - sudo apt-get update
  - sudo apt-get install -y git zip unzip openjdk-11-jdk
  - sudo apt-get install -y build-essential libssl-dev libffi-dev python3-dev
  - sudo apt-get install -y autoconf libtool pkg-config zlib1g-dev libncurses5-dev
  - sudo apt-get install -y libgdbm-dev libnss3-dev libssl-dev libreadline-dev libffi-dev
  - sudo apt-get install -y libsqlite3-dev wget liblzma-dev

install:
  - pip install --upgrade pip wheel setuptools
  - pip install buildozer cython==0.29.19

script:
  - echo "Starting Buildozer build..."
  - buildozer -v android debug

before_cache:
  - rm -rf $HOME/.buildozer/android/platform/android-sdk/tools
  - rm -rf $HOME/.buildozer/android/platform/android-ndk-r19c/sources
  - rm -rf $HOME/.buildozer/android/platform/android-ndk-r19c/toolchains/llvm/prebuilt/linux-x86_64/lib64/clang

cache:
  directories:
    - $HOME/.buildozer
    - $HOME/.gradle/caches/
    - .buildozer

before_deploy:
  - echo "Preparing APK for deployment..."
  - ls -la bin/
  - export APK_FILE=$(find bin -name "*.apk" | head -n 1)
  - echo "APK file: $APK_FILE"

deploy:
  provider: releases
  api_key:
    secure: GITHUB_TOKEN
  file_glob: true
  file: bin/*.apk
  skip_cleanup: true
  on:
    tags: true

